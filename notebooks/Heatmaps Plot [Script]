# 11. CREATING HEATMAPS 

#DATA PREP
# 1. Get the indices (ENSG IDs) of the top 20 most significant genes (lowest padj)
#Filtering out NaNs first ensuring we valid p-values
top_20_indices = res.dropna(subset=['padj']).nsmallest(20, 'padj').index

# Extracting the genes from counts dataframe
heatmap_data = counts.loc[top_20_indices]

# Map the symbols for the Y-axis labels
heatmap_data.index = heatmap_data.index.map(mapping_dict)

# Creating a Heatmap for ALL SAMPLE ID's in Dataset

# Standardizing the data (Z-score) so we see relative changes across rows, 
# otherwise high-expression genes would wash out the whole plot.

g = sns.clustermap(heatmap_data,
                   z_score=0, # 0 indicates row-wise standardization
                   cmap='RdYlBu_r',
                   annot=False,
                   figsize=(10,12))

g.ax_heatmap.set_xticks(np.arange(len(heatmap_data.columns)) + 0.5) # 1. Force the x-axis to show a tick for every single column
g.ax_heatmap.set_xticklabels(heatmap_data.columns, rotation=90, fontsize=7)
g.ax_heatmap.set_yticklabels(g.ax_heatmap.get_yticklabels(), rotation=0, fontsize=8)
g.ax_heatmap.set_title('Top 20 Most Significant Genes (Z-score Normalized)')  

# Creating a Heatmap for the 10 Sample IDs (MIS vs C)

# Geting the indices of the top 20 most significant genes
top_20_indices = res_clean.nsmallest(20, 'padj').index

# Genes set up as ROWS and Samples as COLUMNS for z_score=0 to work on genes
heatmap_data = log_counts[top_20_indices].T 

# Mapping the symbols for the Y-axis labels
heatmap_data.index = heatmap_data.index.map(mapping_dict)

# Defining Column Colors (MIS vs Control)
condition_colors = metaData['Condition'].map({'MIS': 'firebrick', 'C': 'royalblue'})

# CREATING HEATMAP

# z_score=0 now correctly standardizes each GENE (row) across all samples
g = sns.clustermap(heatmap_data, 
                   z_score=0, 
                   cmap='RdYlBu_r', 
                   col_colors=condition_colors, 
                   metric='correlation',
                   method='average',
                   annot=False, 
                   figsize=(10, 12))

# 6. Aesthetic adjustments
plt.setp(g.ax_heatmap.get_xticklabels(), rotation=90, fontsize=9)
plt.setp(g.ax_heatmap.get_yticklabels(), rotation=0, fontsize=10)


# 7. Add Legend
from matplotlib.patches import Patch
legend_elements = [Patch(facecolor='firebrick', label='MIS'),
                   Patch(facecolor='royalblue', label='Control')]
# We attach the legend to the color bar (ax_col_colors) or the figure
plt.legend(handles=legend_elements, bbox_to_anchor=(1.2, 1), 
           loc='upper left', title="Condition")

g.ax_heatmap.set_title('Top 20 DEGs: Z-score Normalized Expression', pad=20)
plt.show()
